<script data-goatcounter="https://roygiorgio.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Europa XS Build Log</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 2rem; background: #f8f8f8; }
  h1 { text-align: center; margin-bottom: 0.25rem; }
  #meta-info { text-align: center; color: #555; margin-bottom: 0.5rem; }

  #tip {
    text-align: left;
    font-style: italic;
    color: #656565;
    margin: 0 0 1.5rem 0.5rem;
  }

  .top-buttons {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .top-buttons a {
    background: #bbb; /* classy medium gray */
    color: #000; /* black text */
    padding: 0.5rem 1rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    border: 1px solid #999;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.25);
    transition: background-color 0.2s ease, box-shadow 0.2s ease;
  }

  .top-buttons a:hover {
    background: #aaa;
    box-shadow: 3px 3px 7px rgba(0,0,0,0.35);
  }

  h2 {
    background: #e8f0fe;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: default;
  }

  .h2-left {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .arrow {
    cursor: pointer;
    font-weight: bold;
    font-size: 1.1rem;
    user-select: none;
  }

  .expand-buttons {
    font-size: 0.9rem;
    color: #656565;
    user-select: none;
  }

  .expand-buttons span {
    cursor: pointer;
    margin-left: 0.5rem;
    text-decoration: underline;
  }

  .category { margin-bottom: 2rem; }
  .entries { display: none; }
  .entry { background: white; margin: 1rem 0; padding: 1rem; border-radius: 0.5rem; }
  .entry h3 { margin-top: 0; }
  .photos { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 0.5rem; }
  .photos img { height: 120px; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
  .photos img:hover { transform: scale(1.05); }

  .back-to-top { text-align: right; margin-top: 0.5rem; }
  .back-to-top a {
    color: #555;
    text-decoration: none;
    font-size: 0.9rem;
    transition: color 0.2s ease;
  }
  .back-to-top a:hover { color: #1a73e8; text-decoration: underline; }

  #sort-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.8rem;
    margin-bottom: 2rem;
  }
  .sort-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 1rem;
  }
  #sort-controls label {
    font-weight: 600;
    margin-right: 0.5rem;
  }
  select {
    padding: 0.4rem 0.6rem;
    font-size: 1rem;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  #lightbox {
    display: none;
    position: fixed;
    z-index: 9999;
    inset: 0;
    background: rgba(0,0,0,0.9);
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  #lightbox img {
    max-height: 90vh;
    max-width: 90vw;
    border-radius: 8px;
  }
  #lightbox .nav {
    position: absolute;
    top: 50%;
    font-size: 3rem;
    color: white;
    cursor: pointer;
    user-select: none;
    padding: 0 1rem;
  }
  #lightbox .nav:hover { color: #ccc; }
  #lightbox #prev { left: 0; }
  #lightbox #next { right: 0; }
  #lightbox #close {
    position: absolute;
    top: 1rem;
    right: 1.5rem;
    font-size: 2rem;
    color: white;
    cursor: pointer;
  }
  #caption {
    color: #ccc;
    font-size: 1rem;
    margin-top: 0.5rem;
    max-width: 90vw;
    text-align: center;
  }

  /* Floating "Top" button â€” present in DOM but hidden via opacity for robustness */
  #toTopBtn {
    position: fixed;
    bottom: 20px;
    right: 25px;
    z-index: 99999;
    background: #1a73e8;
    color: white;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    font-size: 1.2rem;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    display: block;               /* keep in flow so computed styles are reliable */
    opacity: 0;                   /* hide visually until we want to show */
    visibility: hidden;
    transition: opacity 180ms ease, visibility 180ms ease, transform 180ms ease;
    transform: translateY(6px);
  }
  #toTopBtn.visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }
  #toTopBtn:hover { background: #155ab6; }
</style>
</head>
<body>
<div class="top-buttons">
  <a href="RG_The_Builder.html">Aboutâ€¦</a>
  <a href="Europa_Links.html">Europa Linksâ€¦</a>
</div>

<h1>Roy Giorgio's Europa XS Build Log</h1>
<p id="meta-info">Start date: Apr 17, 2025 â€¢ Total hours: <span id="total-time">â€“</span> â€¢ Last updated: â€¦</p>

<div id="sort-controls">
  <div class="sort-row">
    <label for="sort-select">Sort categories:</label>
    <select id="sort-select">
      <option value="date-desc" selected>Date (Newest â†’ Oldest)</option>
      <option value="date-asc">Date (Oldest â†’ Newest)</option>
      <option value="category-asc">Category (A â†’ Z)</option>
      <option value="category-desc">Category (Z â†’ A)</option>
    </select>

    <label for="jump-select">Jump to category:</label>
    <select id="jump-select">
      <option value="">â€” Select a Category â€”</option>
    </select>
  </div>

  <div class="sort-row">
    <label for="entry-sort">Sort entries within category:</label>
    <select id="entry-sort">
      <option value="date-desc" selected>Date (Newest â†’ Oldest)</option>
      <option value="date-asc">Date (Oldest â†’ Newest)</option>
    </select>
  </div>
</div>
<p id="tip">ðŸ’¡ Tip: Click the arrow (â–¶) next to each section title to view individual build entries.</p>

<div id="content"></div>

<!-- Lightbox -->
<div id="lightbox">
  <span id="close">&times;</span>
  <span id="prev" class="nav">&#10094;</span>
  <img id="lightbox-img" src="">
  <div id="caption"></div>
  <span id="next" class="nav">&#10095;</span>
</div>

<!-- Floating "Top" Button -->
<button id="toTopBtn" title="Back to top">â†‘</button>

<script>
/* Fetch logs and render */
fetch("logs.json")
  .then(async (r) => {
    const lastModified = r.headers.get("Last-Modified");
    if (lastModified) {
      const date = new Date(lastModified);
      const formatted = date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric",
      });
      document.getElementById("meta-info").innerHTML =
        `Start date: Apr 17, 2025 â€¢ Total hours: <span id="total-time">â€“</span> â€¢ Last updated: ${formatted}`;
    }
    return r.json();
  })
  .then(data => {
    const container = document.getElementById("content");
    const totalTimeEl = document.getElementById("total-time");
    const sortSelect = document.getElementById("sort-select");
    const entrySort = document.getElementById("entry-sort");
    const jumpSelect = document.getElementById("jump-select");

    function formatTime(secs) {
      const mins = Math.floor(secs / 60);
      const hrs = Math.floor(mins / 60);
      const rem = mins % 60;
      return `${hrs ? hrs + "h " : ""}${rem}m`;
    }

    const totalSeconds = data.reduce((sum, e) => sum + (parseInt(e.timeSpent || 0, 10)), 0);
    totalTimeEl.textContent = formatTime(totalSeconds);

    function render(sortedData) {
      // Save expanded category states before re-rendering
      const openCategories = new Set(
        [...document.querySelectorAll(".category")].filter(cat => {
          const entries = cat.querySelector(".entries");
          return entries && entries.style.display === "block";
        }).map(cat => cat.id)
      );

      container.innerHTML = "";
      jumpSelect.innerHTML = '<option value="">â€” Select a Category â€”</option>';

      const byCategory = {};
      sortedData.forEach(e => {
        if (!e.category) return;
        if (!byCategory[e.category]) byCategory[e.category] = [];
        byCategory[e.category].push(e);
      });

      let categories = Object.keys(byCategory);
      const catOrder = sortSelect.value;

      categories.sort((a, b) => {
        if (catOrder === "category-asc") return a.localeCompare(b);
        if (catOrder === "category-desc") return b.localeCompare(a);

        const latestA = Math.max(...byCategory[a].map(e => new Date(e.created || 0).getTime()));
        const latestB = Math.max(...byCategory[b].map(e => new Date(e.created || 0).getTime()));
        // Math.max may return -Infinity if array empty; coerce to 0
        const ta = isFinite(latestA) ? latestA : 0;
        const tb = isFinite(latestB) ? latestB : 0;

        return catOrder === "date-desc" ? tb - ta : ta - tb;
      });

      const jumpCats = [...categories].sort((a, b) => a.localeCompare(b));
      jumpCats.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        jumpSelect.appendChild(opt);
      });

      categories.forEach(cat => {
        const section = document.createElement("div");
        section.className = "category";
        section.id = cat;

        const catTime = byCategory[cat].reduce((s, e) => s + (parseInt(e.timeSpent || 0, 10)), 0);
        const entriesDiv = document.createElement("div");
        entriesDiv.className = "entries";

        const h2 = document.createElement("h2");
        const left = document.createElement("div");
        left.className = "h2-left";

        const arrow = document.createElement("span");
        arrow.className = "arrow";
        arrow.textContent = "â–¶";

        const title = document.createElement("span");
        title.textContent = `${cat} (${formatTime(catTime)})`;

        const expandBtns = document.createElement("div");
        expandBtns.className = "expand-buttons";
        // Use class names instead of duplicate IDs
        expandBtns.innerHTML = `<span class="expand-all">Expand All</span> | <span class="collapse-all">Collapse All</span>`;

        left.appendChild(arrow);
        left.appendChild(title);
        h2.appendChild(left);
        h2.appendChild(expandBtns);
        section.appendChild(h2);
        section.appendChild(entriesDiv);

        // restore open state if it was open before render
        if (openCategories.has(cat)) {
          entriesDiv.style.display = "block";
          arrow.textContent = "â–¼";
        }

        const entryOrder = entrySort.value;
        byCategory[cat].sort((a, b) =>
          entryOrder === "date-desc"
            ? new Date(b.created) - new Date(a.created)
            : new Date(a.created) - new Date(b.created)
        );

        byCategory[cat].forEach(entry => {
          const div = document.createElement("div");
          div.className = "entry";
          const secs = parseInt(entry.timeSpent || 0, 10);
          const timeDisplay = secs ? formatTime(secs) : "";

          div.innerHTML = `<h3>${entry.title || "(no title)"}</h3>
                           <small>${entry.created || ""}${timeDisplay ? " â€¢ Time spent: " + timeDisplay : ""}</small>
                           <p>${entry.summary || ""}</p>`;

          const photosDiv = document.createElement("div");
          photosDiv.className = "photos";

          if (entry.assets && entry.assets.length > 0) {
            entry.assets.forEach((photo, idx) => {
              let cleaned = photo.filename.trim().replace(/\s+\/|\/\s+/g, "/").replace(/\s{2,}/g, " ").replace(/\s+$/, "");
              const img = document.createElement("img");
              img.dataset.index = idx;
              img.dataset.caption = photo.description || "";
              img.src = encodeURI(cleaned);
              photosDiv.appendChild(img);
            });
          }

          div.appendChild(photosDiv);
          entriesDiv.appendChild(div);
        });

        // Toggle single category
        arrow.addEventListener("click", () => {
          const open = entriesDiv.style.display === "block";
          entriesDiv.style.display = open ? "none" : "block";
          arrow.textContent = open ? "â–¶" : "â–¼";
        });

        // Expand all / Collapse all - use class selectors and guard for null
        const expandAllBtn = expandBtns.querySelector(".expand-all");
        const collapseAllBtn = expandBtns.querySelector(".collapse-all");

        if (expandAllBtn) {
          expandAllBtn.addEventListener("click", () => {
            document.querySelectorAll(".entries").forEach(el => el.style.display = "block");
            document.querySelectorAll(".arrow").forEach(a => a.textContent = "â–¼");
          });
        }
        if (collapseAllBtn) {
          collapseAllBtn.addEventListener("click", () => {
            document.querySelectorAll(".entries").forEach(el => el.style.display = "none");
            document.querySelectorAll(".arrow").forEach(a => a.textContent = "â–¶");
          });
        }

        container.appendChild(section);
      });
    }

    // initial render
    render(data);

    // wire up controls
    sortSelect.addEventListener("change", () => render(data));
    entrySort.addEventListener("change", () => render(data));
    jumpSelect.addEventListener("change", () => {
      const val = jumpSelect.value;
      if (!val) return;

      sortSelect.value = "category-asc";
      render(data);

      // Collapse all categories and arrows
      document.querySelectorAll(".entries").forEach(el => el.style.display = "none");
      document.querySelectorAll(".arrow").forEach(a => a.textContent = "â–¶");

      // Expand selected category
      const section = document.getElementById(val);
      const entries = section?.querySelector(".entries");
      const arrow = section?.querySelector(".arrow");

      if (entries && arrow) {
        entries.style.display = "block";
        arrow.textContent = "â–¼";
        section.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    });


    /* Lightbox */
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightbox-img");
    const caption = document.getElementById("caption");
    const btnPrev = document.getElementById("prev");
    const btnNext = document.getElementById("next");
    const btnClose = document.getElementById("close");
    let currentImages = [];
    let currentIndex = 0;

    document.body.addEventListener("click", e => {
      if (e.target.tagName === "IMG" && e.target.parentElement.classList.contains("photos")) {
        currentImages = [...e.target.parentElement.querySelectorAll("img")];
        currentIndex = currentImages.indexOf(e.target);
        lightbox.style.display = "flex";
        lightboxImg.src = currentImages[currentIndex].src;
        caption.textContent = currentImages[currentIndex].dataset.caption || "";
      }
    });

    function show(offset) {
      if (!currentImages.length) return;
      currentIndex = (currentIndex + offset + currentImages.length) % currentImages.length;
      lightboxImg.src = currentImages[currentIndex].src;
      caption.textContent = currentImages[currentIndex].dataset.caption || "";
    }

    btnPrev.onclick = () => show(-1);
    btnNext.onclick = () => show(1);
    btnClose.onclick = () => lightbox.style.display = "none";
    lightbox.onclick = e => { if (e.target === lightbox) lightbox.style.display = "none"; };
    document.addEventListener("keydown", e => {
      if (lightbox.style.display === "flex") {
        if (e.key === "ArrowLeft") show(-1);
        if (e.key === "ArrowRight") show(1);
        if (e.key === "Escape") lightbox.style.display = "none";
      }
    });
  })
  .catch(err => {
    console.error("Error loading logs.json", err);
    document.getElementById("content").innerHTML = "<p>Could not load build log data.</p>";
  });

/* Floating "Top" button â€” robust, uses scrollingElement and toggles .visible */
(function() {
  const toTopBtn = document.getElementById("toTopBtn");
  if (!toTopBtn) return;

  const scrollEl = document.scrollingElement || document.documentElement || document.body;

  function updateVisibility() {
    const st = scrollEl.scrollTop || window.scrollY || 0;
    if (st > 200) {
      toTopBtn.classList.add("visible");
    } else {
      toTopBtn.classList.remove("visible");
    }
  }

  // Attach listeners
  window.addEventListener("scroll", updateVisibility, { passive: true });
  window.addEventListener("resize", updateVisibility);
  // Ensure state on load
  document.addEventListener("DOMContentLoaded", updateVisibility);
  // Call once now in case DOM is already ready
  updateVisibility();

  toTopBtn.addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  });
})();
</script>
</body>
</html>
