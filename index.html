<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Europa XS Build Log</title>
<style>
  body { font-family: sans-serif; margin: 2rem; background: #f8f8f8; }
  .category { margin-bottom: 2rem; }
  .entry { background: white; margin: 1rem 0; padding: 1rem; border-radius: 0.5rem; }
  .photos img { height: 120px; margin: 4px; border-radius: 8px; cursor: pointer; }
  h2 { background: #eee; padding: 0.5rem 1rem; border-radius: 8px; }
</style>
</head>
<body>
<h1>Europa XS Build Log</h1>
<div id="content"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
Papa.parse("logs.csv", {
  download: true,
  header: true,
  complete: function(results) {
    const container = document.getElementById("content");
    const byCategory = {};

    // Group entries by category
    results.data.forEach(e => {
      if (!e.Category) return;
      if (!byCategory[e.Category]) byCategory[e.Category] = [];
      byCategory[e.Category].push(e);
    });

    // Sort categories alphabetically
    const categories = Object.keys(byCategory).sort();

    categories.forEach(cat => {
      const section = document.createElement("div");
      section.className = "category";
      section.innerHTML = `<h2>${cat}</h2>`;

      // Sort entries by date (oldest to newest)
      byCategory[cat].sort((a, b) => new Date(a.Created) - new Date(b.Created));

      byCategory[cat].forEach(e => {
        const div = document.createElement("div");
        div.className = "entry";
        div.innerHTML = `
          <h3>${e.Title || "(no title)"}</h3>
          <p><em>${e.Created}</em></p>
          <p>${e.Summary || ""}</p>
          <div class="photos"></div>
        `;

        // Load photos from the matching folder
        const photosDiv = div.querySelector(".photos");
        const folder = encodeURIComponent(cat.trim());
        fetch(`Photo Assets/${folder}/`)
          .then(res => {
            if (!res.ok) throw new Error("Folder not accessible");
            return res.text();
          })
          .then(text => {
            // Look for .jpg links in Netlify’s generated directory listing
            const matches = [...text.matchAll(/href="([^"]+\.jpg)"/gi)];
            matches.forEach(m => {
              const img = document.createElement("img");
              img.src = `Photo Assets/${folder}/${decodeURIComponent(m[1])}`;
              photosDiv.appendChild(img);
            });
          })
          .catch(() => {
            // Silent fail if Netlify doesn’t show folder listing
          });

        section.appendChild(div);
      });

      container.appendChild(section);
    });
  }
});
</script>
</body>
</html>
